<!DOCTYPE html>
<head>
<meta charset="utf-8">
<style>

body {
  margin: 0;

}

path {
  fill: none;
  stroke: black;
  stroke-width: 0.5;
}

</style>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="//d3js.org/d3.geo.tile.v0.min.js"></script>
</head>
<body>

<script>

var width = 1000; //Math.max(1000, window.innerWidth-50),
    height = 800; // Math.max(800, window.innerHeight-50);

var tile = d3.geo.tile()
    .size([width, height]);

var path = d3.geo.path()
    .projection(null)

var zoom = d3.behavior.zoom()
    .scale(512)
    .scaleExtent([256, 4096])
    .translate([width - 900, height - 900])
    .on("zoom", zoomed);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var raster = svg.append("g");
var vector = svg.append("path");

d3.json("sfshtr.json", function(error, sfshtr) {
  if (error) throw error;
  var sftracts = topojson.feature(sfshtr, sfshtr.objects.__sftracts);
  vector
      .attr("d", path(sftracts));
});

svg.call(zoom);
zoomed;

function zoomed() {
   var tiles = tile
      .scale(zoom.scale())
      .translate(zoom.translate())
      ();

  vector
    .attr("d", path)
     .attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")");

  var image = raster
      .attr("transform", "scale(" + tiles.scale + ")translate(" + tiles.translate + ")")
      .selectAll("image")
      .data(tiles, function(d) { return d; });

  image.exit()
      .remove();

  image.enter()
      .append("image")
      .attr("xlink:href", function(d) { 
        var baseUrl = "https://storage.googleapis.com/sfutc_tls/";
        var x = d[0];
        var y = d[1];
        if (x < 0 || y < 0) {
          return baserUrl + "white.png";
        }
        var f = Math.pow(2, d[2]);
        if (f == 1 && (x > 3 || y > 3) 
          ||  f == 2 && (x > 7 || y > 6) 
          ||  f == 4 && (x > 14 || y > 12) 
          ||  f == 8 && (x > 29 || y > 24) 
          ||  f == 16 && (x > 57 || y > 49) ) {
         return baseUrl + "white.png";
        }
        var z = d[2] + 13;
        return baseUrl + z + "/" + (x+1308*f) + "/" + (y+3165*f) + ".png";
       })
      .attr("width", 1)
      .attr("height", 1)
      .attr("x", function(d) { return d[0]; })
      .attr("y", function(d) { return d[1]; });
  }

</script>
</body>
</html>